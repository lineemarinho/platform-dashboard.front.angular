<app-page-title [title]="'extract' | locale"></app-page-title>

<app-balance-cards
  [cards]="balanceCards"
  [selectedCardId]="selectedBalanceCardId"
  (cardSelected)="onBalanceCardSelected($event)"
></app-balance-cards>

<div class="mb-6">
  <div class="flex flex-col md:flex-row gap-4 items-center">
    <div class="relative filters-dropdown">
      <div
        class="flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50"
        (click)="toggleFiltersDropdown()"
      >
        <span class="material-icons text-gray-600 text-sm">filter_list</span>
        <span class="text-sm text-gray-700">{{ "filters" | locale }}</span>
        <span class="material-icons text-gray-600 text-xs">expand_more</span>
      </div>

      <div
        *ngIf="showFiltersDropdown"
        class="absolute top-full left-0 mt-1 bg-white rounded-lg shadow-lg border border-gray-200 z-50 min-w-[200px]"
      >
        <div
          class="absolute -top-2 left-4 w-4 h-4 bg-white border-l border-t border-gray-200 transform rotate-45"
        ></div>

        <div class="p-4">
          <div
            *ngFor="let option of filterOptions"
            class="flex items-center gap-3 py-2 cursor-pointer hover:bg-gray-50 rounded px-2"
            (click)="toggleFilterOption(option.key)"
          >
            <div
              class="w-4 h-4 border-2 rounded flex items-center justify-center transition-colors"
              [class]="
                option.checked
                  ? 'bg-slate-600 border-slate-600'
                  : 'border-gray-300 bg-white'
              "
            >
              <svg
                *ngIf="option.checked"
                class="w-3 h-3 text-white"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
            <span class="text-sm text-gray-700">{{ option.label }}</span>
          </div>
        </div>

        <div class="flex gap-2 p-4 border-t border-gray-200">
          <button
            class="flex-1 px-4 py-2 text-sm border border-slate-600 text-slate-600 rounded-lg hover:bg-slate-50 transition-colors"
            (click)="clearFilters()"
          >
            {{ "clear" | locale }}
          </button>
          <button
            class="flex-1 px-4 py-2 text-sm bg-slate-600 text-white rounded-lg hover:bg-slate-700 transition-colors"
            (click)="applyFilters()"
          >
            {{ "filter" | locale }}
          </button>
        </div>
      </div>
    </div>

    <div class="relative date-dropdown">
      <div
        class="flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50"
        (click)="toggleDateDropdown()"
      >
        <span class="material-icons text-gray-600 text-sm">calendar_today</span>
        <span class="text-sm text-gray-700">{{ getSelectedDateLabel() }}</span>
        <span class="material-icons text-gray-600 text-xs">expand_more</span>
      </div>

      <div
        *ngIf="showDateDropdown"
        class="absolute top-full left-0 mt-1 bg-white rounded-lg shadow-lg border border-gray-200 z-50 min-w-[200px]"
      >
        <div
          class="absolute -top-2 left-4 w-4 h-4 bg-white border-l border-t border-gray-200 transform rotate-45"
        ></div>

        <div class="py-2">
          <div
            *ngFor="let option of dateOptions"
            class="px-4 py-2 cursor-pointer hover:bg-gray-50 transition-colors"
            [class]="selectedDateOption === option.key ? 'bg-gray-50' : ''"
            (click)="selectDateOption(option.key)"
          >
            <span class="text-sm text-gray-700">{{ option.label }}</span>
          </div>
        </div>
      </div>

      <div
        *ngIf="showCustomDateInputs"
        class="absolute top-full left-0 mt-1 bg-white rounded-lg shadow-lg border border-gray-200 z-50 min-w-[280px]"
      >
        <div
          class="absolute -top-2 left-4 w-4 h-4 bg-white border-l border-t border-gray-200 transform rotate-45"
        ></div>

        <div class="p-4">
          <h4 class="text-sm font-medium text-gray-700 mb-3">
            Personalizar período
          </h4>

          <div class="space-y-3">
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1"
                >Data de início</label
              >
              <input
                type="date"
                [(ngModel)]="customStartDate"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-slate-500 focus:border-transparent"
              />
            </div>

            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1"
                >Data final</label
              >
              <input
                type="date"
                [(ngModel)]="customEndDate"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-slate-500 focus:border-transparent"
              />
            </div>
          </div>

          <div class="flex gap-2 mt-4 pt-3 border-t border-gray-200">
            <button
              class="flex-1 px-3 py-2 text-sm border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
              (click)="cancelCustomPeriod()"
            >
              Cancelar
            </button>
            <button
              class="flex-1 px-3 py-2 text-sm bg-slate-600 text-white rounded-lg hover:bg-slate-700 transition-colors"
              (click)="applyCustomPeriod()"
            >
              Aplicar
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="flex-1 relative">
      <input
        type="text"
        [placeholder]="'searchValueTypeEntry' | locale"
        class="w-full px-4 py-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-500 focus:border-transparent"
      />
      <span
        class="material-icons absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"
      >
        search
      </span>
    </div>
  </div>
</div>

<app-table
  [columns]="tableColumns"
  [rows]="tableRows"
  [columnMap]="columnMap"
  [expandedDataMap]="expandedDataMap"
  [expandedContentTemplate]="extractExpandedTemplate"
></app-table>

<ng-template #extractExpandedTemplate let-row let-data="data">
  <div class="space-y-4">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div *ngFor="let detail of data | keyvalue" class="flex flex-col">
        <span class="text-xs font-medium text-gray-500 mb-1">
          {{ detail.key?.toString() || "" | locale }}
        </span>
        <span class="text-sm text-gray-900">
          {{ detail.value }}
        </span>
      </div>
    </div>

    <div class="flex justify-start pt-4 border-t border-gray-200">
      <app-button
        type="outline"
        [label]="'openReceipt' | locale"
        (click)="openReceipt(row)"
        class="flex items-center gap-2"
      >
        <span class="material-icons text-sm">check</span>
      </app-button>
    </div>
  </div>
</ng-template>

<app-receipt
  [isOpen]="isReceiptOpen"
  [receiptData]="currentReceiptData"
  (close)="closeReceipt()"
></app-receipt>
